function XElement(e){if(this.attrs={},this.children=[],this.events={},this.funcs={},this.tempAttrs=[],this.vars=[],this.funcData={},this._renderVersion=-1,e.el&&!e.view&&!this.noBuild)throw new Error("XElement requires a view to be set if it's going to attempt to build");for(var t in e)this[t]=e[t];this.parent&&(this.noLink=this.parent.noLink),this.el&&!this.noBuild&&this.build()}function View(e){this.el=e instanceof Element?e:document.querySelector(e),this.data={},this._prevData={},this.watching={},this.usesVars={},this.tempEls={add:{},remove:{}},this._renderVersion=0,this.build()}XElement.prototype.renderString=function(e,t){return e.render.map(function(i){if("number"==typeof i){if(t&&void 0!==t[e.vars[i]]){var n=t[e.vars[i]];return n instanceof Function?n.call(t,this):t[e.vars[i]]}return""}return i}).join("")},XElement.prototype.build=function(){this.el.XElement=this;for(var e=[],t=0;t<this.el.attributes.length;t++){var i=this.el.attributes[t],n=this.variablePosition(i.value);if(e.push(n),0===i.name.indexOf("x-")){var r=i.name.substr(2);this.extend[r]?this.funcs[r]={group:n,fn:new this.extend[r]}:console.warn("x-"+r+" is not a valid function @",this.el),this.el.removeAttribute(i.name),t--}else n.vars.length&&(this.attrs[i.name]=n)}this.runFuncs("build"),Array.prototype.forEach.call(this.el.childNodes,function(t){if(!(t instanceof Text)){var i=new XElement({view:this.view,el:t,parent:this});return i.index=this.children.length,this.children.push(i)}var n=this.variablePosition(t.nodeValue);e.push(n),t.XElement={el:t,render:n},n.vars&&this.children.push(t.XElement)}.bind(this)),this.noLink||e.forEach(function(e){e.vars.forEach(function(e){this.vars.indexOf(e)<0&&(this.vars.push(e),this.view&&(this.view.usesVars[e]=this.view.usesVars[e]||[],this.view.usesVars[e].push(this))),this.parent&&this.parent.vars.indexOf(e)<0&&this.parent.vars.push(e)}.bind(this))}.bind(this))},XElement.prototype.variablePosition=function(e){var t={vars:[],render:[e]};return e.replace(/\${([^}]*)}/g,function(e,i){var n=t.vars.indexOf(i),r=t.render[t.render.length-1];n<0&&(n=t.vars.push(i)-1),(r=r.split("${"+i+"}")).splice(1,0,n),t.render.splice(-1,1),t.render=t.render.concat(r)}.bind(this)),t},XElement.prototype.runFuncs=function(e){for(var t in this.funcs){var i=this.renderString(this.funcs[t].group,this.data);this.funcs[t].fn[e]&&this.funcs[t].fn[e](i,this)}},XElement.prototype.render=function(e){if(this.data=e||this.data,!this.data)for(var t=this.parent;!this.data&&t;)this.data=t.data,t=t.parent;this.parent&&this.runFuncs("render"),this.tempAttrs.forEach(function(e){this.el.removeAttribute(e)}.bind(this));for(var i in this.attrs)this.el.setAttribute(i,this.renderString(this.attrs[i],this.data));for(var n in this.events)this.events[n].forEach(function(e){this.el.addEventListener(n,e)}.bind(this));return this.children.forEach(function(e){e instanceof XElement&&this.noLink?e.render(this.data):e.el instanceof Text&&(e.el.nodeValue=this.renderString(e.render,this.data))}.bind(this)),this.el},XElement.prototype.useVar=function(e){this.vars.indexOf(e)<0&&(this.vars.push(e),this.view.usesVars[e]=this.view.usesVars[e]||[],this.view&&this.view.usesVars[e].indexOf(this)<0&&this.view.usesVars[e].push(this)),this.parent&&this.parent.vars.indexOf(e)<0&&this.parent.vars.push(e)},XElement.prototype.tempAttr=function(e,t){this.el.setAttribute(e,t),this.tempAttrs.indexOf(e)<0&&this.tempAttrs.push(e)},XElement.prototype.cloneableProperties=["index","attrs","funcs","events","tempAttrs","noLink"],XElement.prototype.copy=function(e){function t(e){if("object"!=typeof e||Array.isArray(e))return e;var i={};for(var n in e)i[n]=t(e[n]);return i}var i={view:this.view,el:this.el.cloneNode(),noBuild:!0};for(var n in e)i[n]=e[n];var r=new XElement(i);return r.parent=parent,this.cloneableProperties.forEach(function(e){r[e]=t(this[e])}.bind(this)),Array.prototype.forEach.call(this.el.childNodes,function(e){if(e.XElement){var t;(e=e.XElement)instanceof XElement?t=e.copy({parent:r}):(t={el:e.el.cloneNode(),render:e.render}).el.XElement=t,r.el.appendChild(t.el),r.children.push(t)}else r.el.appendChild(e)}),r},XElement.prototype.extend={},XElement.prototype.extend.foreach=function(){this.build=function(e,t){t.noLink=!0;for(var i,n=t.parent;n;)n.funcs.foreach&&(i=n),n=n.parent;i?this.forEachParent=i.funcs.foreach.fn:t.useVar(e)},this.render=function(e,t){var i=e;this.forEachParent?i=this.forEachParent.group:this.group=e;var n=t.data[e];if(n&&n.length){if(n.constructor!==Array)return console.warn("x-foreach expects an array @",t.el);var r=t.el.parentNode,s=t.el.nextSibling;n.forEach(function(e,n){if("object"!=typeof e&&(e={base:e}),e.i=n,n>0){var a=t.copy({parent:t.parent});delete a.funcs.foreach;var o=a.render(e);t.view.setTemporaryElement(o,i),r.insertBefore(o,s)}else t.data=e}.bind(this))}else t.view.temporarilyRemoveElement(t.el,i)}},XElement.prototype.extend.id=function(){this.build=function(e,t){t.view.ids=t.view.ids||{},t.view.ids[e]=t}},XElement.prototype.extend.html=function(){this.render=function(e,t){t.el.innerHTML=e}},XElement.prototype.extend.show=function(){this.build=function(e,t){"!"==e.substring(0,1)&&(this.inverse=!0,e=e.substring(1)),this.scope=e.split(/\.|\[|\]/g).filter(function(e){return e.length}),t.useVar(this.scope[0]),this.render(e,t)},this.render=function(e,t){for(var i=t.data,n=0;n<this.scope.length;n++)i=!(!i||!i[this.scope[n]])&&i[this.scope[n]];(!(i=i instanceof Function?i.call(t.data,t):i)&&!this.inverse||i&&this.inverse&&i.length)&&t.view.temporarilyRemoveElement(t.el,this.scope[0])}},XElement.prototype.extend.value=function(){this.build=function(e,t){t.useVar(e),t.el.onchange=t.el.onkeyup=function(){t.view.set(e,t.el.value)}},this.render=function(e,t){t.el.value=(t.data[e]instanceof Function?t.data[e].call(t.data,t):t.data[e])||""}},View.prototype.find=function(e){return this.el.querySelector(e).XElement},View.prototype.render=function(e){function t(e,i){if("object"!=typeof e||"object"!=typeof i)return e===i;for(var n in e)if(!t(e[n],i[n]))return!1;for(var n in i)if(!t(e[n],i[n]))return!1;return!0}this.data=e||this.data;var i=[];for(var n in this.data)t(this.data[n],this._prevData[n])||i.push(n);for(var n in this._prevData)!t(this.data[n],this._prevData[n])&&i.indexOf(n)<0&&i.push(n);i.forEach(this.renderVariable.bind(this)),this._renderVersion++},View.prototype.renderVariable=function(e){this.tempEls.add[e]&&(this.tempEls.add[e].forEach(function(e){(e.parentNode||e.oldParent)&&(e.parentNode||e.oldParent).removeChild(e)}),this.tempEls.add[e]=[]),this.tempEls.remove[e]&&(this.tempEls.remove[e].forEach(function(e){(e.sibling.parentNode||e.sibling.oldParent).insertBefore(e.el,e.sibling)}),this.tempEls.remove[e]=[]),this.usesVars[e]&&this.usesVars[e].forEach(function(e){this._renderVersion>e._renderVersion&&(e._renderVersion=this._renderVersion,e.render(this.data))}.bind(this))},View.prototype.build=function(){this._structure=new XElement({view:this,el:this.el})},View.prototype.set=function(e,t){function i(e){if("object"!=typeof e||Array.isArray(e))return e;var t={};for(var n in e)t[n]=i(e[n]);return t}this._prevData=this.data,this.data=i(this.data),this.data[e]=t,this.usesVars[e]=this.usesVars[e]||[],this.renderVariable(e),this._renderVersion++,this.watching[e]&&this.watching[e].forEach(function(e){e()}.bind(this))},View.prototype.setTemporaryElement=function(e,t){this.tempEls.add[t]=this.tempEls.add[t]||[],this.tempEls.add[t].indexOf(e)<0&&this.tempEls.add[t].push(e)},View.prototype.temporarilyRemoveElement=function(e,t){e.XElement&&e.XElement.hide instanceof Function?e.XElement.hide(e.XElement):(this.tempEls.remove[t]=this.tempEls.remove[t]||[],this.tempEls.remove[t].indexOf(e)<0&&this.tempEls.remove[t].push({el:e,sibling:e.nextSibling}),e.oldParent=e.parentNode,e.parentNode.removeChild(e))},View.prototype.watch=function(e,t){this.watching[e]=this.watching[e]||[],this.watching[e].indexOf(t)<0&&this.watching[e].push(t.bind(this))};