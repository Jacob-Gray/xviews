function XElement(t){if(this.attrs={},this.children=[],this.events={},this.funcs={},this.tempAttrs=[],this.vars=[],this.funcData={},this._renderVersion=-1,t.el&&!t.view&&!this.noBuild)throw new Error("XElement requires a view to be set if it's going to attempt to build");for(var e in t)this[e]=t[e];this.parent&&(this.noLink=this.parent.noLink),this.el&&!this.noBuild&&this.build()}function View(t){this.el=t instanceof Element?t:document.querySelector(t),this.data={},this._prevData={},this.watching={},this.usesVars={},this.tempEls={add:{},remove:{}},this._renderVersion=0,this.build()}XElement.prototype.renderString=function(t,e){return t.render.map(function(i){if("number"==typeof i){if(e&&void 0!==e[t.vars[i]]){var n=e[t.vars[i]];return n instanceof Function?n.call(e,this):e[t.vars[i]]}return""}return i}).join("")},XElement.prototype.build=function(){this.el.XElement=this;for(var t=[],e=0;e<this.el.attributes.length;e++){var i=this.el.attributes[e],n=this.variablePosition(i.value);if(t.push(n),0===i.name.indexOf("x-")){var s=i.name.substr(2);this.extend[s]?this.funcs[s]={group:n,fn:new this.extend[s]}:console.warn("x-"+s+" is not a valid function @",this.el),this.el.removeAttribute(i.name),e--}else n.vars.length&&(this.attrs[i.name]=n)}this.runFuncs("build"),Array.prototype.forEach.call(this.el.childNodes,function(e){if(!(e instanceof Text)){var i=new XElement({view:this.view,el:e,parent:this});return i.index=this.children.length,this.children.push(i)}var n=this.variablePosition(e.nodeValue);t.push(n),e.XElement={el:e,render:n},n.vars&&this.children.push(e.XElement)}.bind(this)),this.noLink||t.forEach(function(t){t.vars.forEach(function(t){this.vars.indexOf(t)<0&&(this.vars.push(t),this.view&&(this.view.usesVars[t]=this.view.usesVars[t]||[],this.view.usesVars[t].push(this))),this.parent&&this.parent.vars.indexOf(t)<0&&this.parent.vars.push(t)}.bind(this))}.bind(this))},XElement.prototype.variablePosition=function(t){var e={vars:[],render:[t]};return t.replace(/\${([^}]*)}/g,function(t,i){var n=e.vars.indexOf(i),s=e.render[e.render.length-1];n<0&&(n=e.vars.push(i)-1),(s=s.split("${"+i+"}")).splice(1,0,n),e.render.splice(-1,1),e.render=e.render.concat(s)}.bind(this)),e},XElement.prototype.runFuncs=function(t){for(var e in this.funcs){var i=this.renderString(this.funcs[e].group,this.data);this.funcs[e].fn[t]&&this.funcs[e].fn[t](i,this)}},XElement.prototype.render=function(t){if(this.data=t||this.data,!this.data)for(var e=this.parent;!this.data&&e;)this.data=e.data,e=e.parent;this.parent&&this.runFuncs("render"),this.tempAttrs.forEach(function(t){this.el.removeAttribute(t)}.bind(this));for(var i in this.attrs)this.el.setAttribute(i,this.renderString(this.attrs[i],this.data));for(var n in this.events)this.events[n].forEach(function(t){this.el.addEventListener(n,t)}.bind(this));return this.children.forEach(function(t){t instanceof XElement&&this.noLink?t.render(this.data):t.el instanceof Text&&(t.el.nodeValue=this.renderString(t.render,this.data))}.bind(this)),this.el},XElement.prototype.useVar=function(t){this.vars.indexOf(t)<0&&(this.vars.push(t),this.view.usesVars[t]=this.view.usesVars[t]||[],this.view&&this.view.usesVars[t].indexOf(this)<0&&this.view.usesVars[t].push(this)),this.parent&&this.parent.vars.indexOf(t)<0&&this.parent.vars.push(t)},XElement.prototype.tempAttr=function(t,e){this.el.setAttribute(t,e),this.tempAttrs.indexOf(t)<0&&this.tempAttrs.push(t)},XElement.prototype.cloneableProperties=["index","attrs","funcs","events","tempAttrs","noLink"],XElement.prototype.copy=function(t){function e(t){if("object"!=typeof t||Array.isArray(t))return t;var i={};for(var n in t)i[n]=e(t[n]);return i}var i={view:this.view,el:this.el.cloneNode(),noBuild:!0};for(var n in t)i[n]=t[n];var s=new XElement(i);return s.parent=parent,this.cloneableProperties.forEach(function(t){s[t]=e(this[t])}.bind(this)),Array.prototype.forEach.call(this.el.childNodes,function(t){if(t.XElement){var e;(t=t.XElement)instanceof XElement?e=t.copy({parent:s}):(e={el:t.el.cloneNode(),render:t.render}).el.XElement=e,s.el.appendChild(e.el),s.children.push(e)}else s.el.appendChild(t)}),s},XElement.prototype.extend={},View.prototype.find=function(t){return this.el.querySelector(t).XElement},View.prototype.render=function(t){function e(t,i){if("object"!=typeof t||"object"!=typeof i)return t===i;for(var n in t)if(!e(t[n],i[n]))return!1;for(var n in i)if(!e(t[n],i[n]))return!1;return!0}this.data=t||this.data;var i=[];for(var n in this.data)e(this.data[n],this._prevData[n])||i.push(n);for(var n in this._prevData)!e(this.data[n],this._prevData[n])&&i.indexOf(n)<0&&i.push(n);i.forEach(this.renderVariable.bind(this)),this._renderVersion++},View.prototype.renderVariable=function(t){this.tempEls.add[t]&&(this.tempEls.add[t].forEach(function(t){(t.parentNode||t.oldParent)&&(t.parentNode||t.oldParent).removeChild(t)}),this.tempEls.add[t]=[]),this.tempEls.remove[t]&&(this.tempEls.remove[t].forEach(function(t){(t.sibling.parentNode||t.sibling.oldParent).insertBefore(t.el,t.sibling)}),this.tempEls.remove[t]=[]),this.usesVars[t]&&this.usesVars[t].forEach(function(t){this._renderVersion>t._renderVersion&&(t._renderVersion=this._renderVersion,t.render(this.data))}.bind(this))},View.prototype.build=function(){this._structure=new XElement({view:this,el:this.el})},View.prototype.set=function(t,e){function i(t){if("object"!=typeof t||Array.isArray(t))return t;var e={};for(var n in t)e[n]=i(t[n]);return e}this._prevData=this.data,this.data=i(this.data),this.data[t]=e,this.usesVars[t]=this.usesVars[t]||[],this.renderVariable(t),this._renderVersion++,this.watching[t]&&this.watching[t].forEach(function(t){t()}.bind(this))},View.prototype.setTemporaryElement=function(t,e){this.tempEls.add[e]=this.tempEls.add[e]||[],this.tempEls.add[e].indexOf(t)<0&&this.tempEls.add[e].push(t)},View.prototype.temporarilyRemoveElement=function(t,e){t.XElement&&t.XElement.hide instanceof Function?t.XElement.hide(t.XElement):(this.tempEls.remove[e]=this.tempEls.remove[e]||[],this.tempEls.remove[e].indexOf(t)<0&&this.tempEls.remove[e].push({el:t,sibling:t.nextSibling}),t.oldParent=t.parentNode,t.parentNode.removeChild(t))},View.prototype.watch=function(t,e){this.watching[t]=this.watching[t]||[],this.watching[t].indexOf(e)<0&&this.watching[t].push(e.bind(this))};